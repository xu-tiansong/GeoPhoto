<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photos Management</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background-color: #2a2a2a;
            color: #e0e0e0;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            user-select: none;
        }

        /* ── Title Bar ─────────────────────────────────── */
        .title-bar {
            -webkit-app-region: drag;
            height: 40px;
            background: rgba(0,0,0,0.45);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 14px;
            border-bottom: 1px solid #2e2e2e;
            flex-shrink: 0;
        }
        .title-bar-text { font-size: 14px; font-weight: 500; color: #ddd; }
        .title-bar-close {
            -webkit-app-region: no-drag;
            width: 30px; height: 30px;
            background: #c62828;
            border: none; border-radius: 4px;
            cursor: pointer; color: #fff; font-size: 18px; line-height: 1;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.15s;
        }
        .title-bar-close:hover { background: #b71c1c; }

        /* ── Main Layout ───────────────────────────────── */
        .main { flex: 1; display: flex; overflow: hidden; }

        /* 左侧容器 */
        .left-panel {
            width: 250px;
            background-color: #1a1a1a;
            border-right: 1px solid #2e2e2e;
            display: flex;
            flex-direction: column;
        }

        /* Tab 容器 */
        .tabs {
            display: flex;
            background-color: #1f1f1f;
            border-bottom: 1px solid #2e2e2e;
        }

        .tab {
            flex: 1;
            padding: 10px 0;
            text-align: center;
            cursor: pointer;
            background: transparent;
            border: none;
            color: #666;
            font-size: 12px;
            font-family: inherit;
            transition: all 0.18s;
            border-bottom: 2px solid transparent;
        }

        .tab:hover {
            background: rgba(255,255,255,0.04);
            color: #bbb;
        }

        .tab.active {
            color: #e0e0e0;
            border-bottom-color: #4a9eff;
            background: transparent;
        }

        /* Tab 内容区 */
        .tab-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        /* 地图缩略图 */
        .map-thumbnail {
            width: 100%;
            height: 200px;
            background-color: #1a1a1a;
            border-radius: 4px;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }

        #selectedMapContainer {
            width: 100%;
            height: 100%;
        }

        .map-overlay {
            position: absolute;
            bottom: 8px;
            left: 8px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            color: white;
        }

        /* 右侧照片网格容器 */
        .right-panel {
            flex: 1;
            background-color: #2a2a2a;
            overflow-y: auto;
            padding: 16px;
            outline: none; /* 移除焦点时的默认轮廓 */
        }

        .photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, 224px);
            gap: 16px;
            justify-content: start;
        }

        .photo-item {
            width: 224px;
            height: 224px;
            position: relative;
            cursor: pointer;
            border: 3px solid transparent;
            border-radius: 4px;
            overflow: hidden;
            background-color: #1a1a1a;
            transition: border-color 0.2s;
        }

        .photo-item.loading {
            background: linear-gradient(90deg, #1a1a1a 25%, #2a2a2a 50%, #1a1a1a 75%);
            background-size: 200% 100%;
            animation: loading 1.5s ease-in-out infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .photo-item:hover {
            border-color: #555;
        }

        .photo-item.selected {
            border-color: #4a9eff;
        }

        .photo-item img,
        .photo-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .photo-item .video-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 48px;
            height: 48px;
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .photo-item .video-overlay::after {
            content: '';
            width: 0;
            height: 0;
            border-left: 16px solid white;
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
            margin-left: 4px;
        }

        .photo-item .photo-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
            padding: 8px;
            font-size: 11px;
            color: #ccc;
        }

        .photo-item .like-icon {
            position: absolute;
            top: 6px;
            right: 6px;
            color: #ff6b6b;
            font-size: 14px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
            z-index: 5;
        }

        /* 滚动条样式 */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3a3a3a; border-radius: 3px; }

        .info-text {
            padding: 16px;
            color: #888;
            text-align: center;
        }

    </style>
</head>
<body>
    <!-- 顶部标题栏 -->
    <div class="title-bar">
        <div class="title-bar-text" data-i18n="manage.title">Photos Management</div>
        <button class="title-bar-close" id="closeBtn">×</button>
    </div>

    <div class="main">
    <!-- 左侧面板 -->
    <div class="left-panel">
        <div class="tabs">
            <button class="tab active" data-tab="direct" data-i18n="manage.tabDirect">Direct</button>
            <button class="tab" data-tab="selected" data-i18n="manage.tabSelected">Selected</button>
            <button class="tab" data-tab="tag" data-i18n="manage.tabTag">Tag</button>
        </div>
        <div class="tab-content">
            <div class="tab-panel active" id="direct-panel">
                <div class="info-text" data-i18n="manage.directPlaceholder">Direct mode content will be here</div>
            </div>
            <div class="tab-panel" id="selected-panel">
                <div class="map-thumbnail">
                    <div id="selectedMapContainer"></div>
                    <div class="map-overlay">
                        <span id="photo-count-badge">0 photos</span>
                    </div>
                </div>
                <div class="info-text"><span data-i18n="manage.selected">Selected: </span><span id="selected-count">-</span></div>
            </div>
            <div class="tab-panel" id="tag-panel">
                <div class="info-text" data-i18n="manage.tagPlaceholder">Tag management will be here</div>
            </div>
        </div>
    </div>

    <!-- 右侧照片网格 -->
    <div class="right-panel" tabindex="0">
        <div class="photos-grid" id="photosGrid"></div>
    </div>
    </div><!-- /.main -->

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>

    <script>
        const { ipcRenderer } = require('electron');
        const ThumbnailGenerator = require('./modules/ThumbnailGenerator');
        const i18n = require('./modules/i18n');

        // i18n 初始化
        (async () => {
            const lang = await ipcRenderer.invoke('get-language');
            i18n.applyToDOM(document, lang);
        })();
        ipcRenderer.on('language-changed', (_event, lang) => {
            i18n.applyToDOM(document, lang);
        });

        let currentPhotos = [];
        let sortedCurrentPhotos = []; // 按时间排序后的照片列表，用于照片预览窗口翻页
        let selectedPhotoId = null; // 改为单选
        let mapBounds = null;
        let intersectionObserver = null;
        let clickTimer = null; // 用于延迟处理单击事件
        
        // 缩略图生成队列
        let thumbnailQueue = [];
        let isProcessingThumbnail = false;
        
        // 小地图实例
        let miniMap = null;
        let miniMapMarkers = [];

        // 等待DOM加载完成后再初始化
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM加载完成，开始初始化...');
            initializeApp();
        });

        function initializeApp() {
            // Tab 切换逻辑
            const tabs = document.querySelectorAll('.tab');
            const tabPanels = document.querySelectorAll('.tab-panel');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    switchTab(tabName);
                });
            });

            // 关闭按钮
            const closeBtn = document.getElementById('closeBtn');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    console.log('关闭按钮被点击');
                    // 清理 observer
                    if (intersectionObserver) {
                        intersectionObserver.disconnect();
                    }
                    // 清理地图实例
                    if (miniMap) {
                        miniMap.remove();
                        miniMap = null;
                        miniMapMarkers = [];
                    }
                    window.close();
                });
            } else {
                console.error('找不到关闭按钮！');
            }

            // 页面加载完成后，给右侧面板设置焦点
            const rightPanel = document.querySelector('.right-panel');
            if (rightPanel) {
                setTimeout(() => {
                    rightPanel.focus();
                }, 200);
            }
        }

        function switchTab(tabName) {
            console.log('切换到tab:', tabName);
            const tabs = document.querySelectorAll('.tab');
            const tabPanels = document.querySelectorAll('.tab-panel');
            
            tabs.forEach(t => t.classList.remove('active'));
            tabPanels.forEach(p => p.classList.remove('active'));

            const activeTab = document.querySelector(`.tab[data-tab="${tabName}"]`);
            const activePanel = document.getElementById(`${tabName}-panel`);

            if (activeTab) {
                activeTab.classList.add('active');
            } else {
                console.error('找不到tab:', tabName);
            }
            
            if (activePanel) {
                activePanel.classList.add('active');
            } else {
                console.error('找不到tab panel:', tabName);
            }

            // 如果切换到 selected tab，重新绘制地图
            if (tabName === 'selected' && mapBounds) {
                console.log('准备绘制地图...');
                setTimeout(() => {
                    if (miniMap) {
                        console.log('地图已存在，刷新尺寸');
                        miniMap.invalidateSize();
                    } else {
                        console.log('绘制新地图');
                        drawMapThumbnail();
                    }
                }, 150);
            }
        }

        // 初始化照片数据
        ipcRenderer.on('init-photos', (event, options) => {
            console.log('收到初始化数据:', options);
            
            // 先设置数据
            if (options.photos) {
                currentPhotos = options.photos;
                console.log('设置照片数量:', currentPhotos.length);
            }
            
            if (options.bounds) {
                mapBounds = options.bounds;
                console.log('设置地图边界:', mapBounds);
            }
            
            // 然后切换tab
            if (options.tab) {
                console.log('切换到tab:', options.tab);
                switchTab(options.tab);
            }
            
            // 最后渲染照片
            if (options.photos) {
                setTimeout(() => {
                    renderPhotos();
                    updateSelectedCount();
                }, 50);
            }
        });

        // 更新照片数据
        ipcRenderer.on('update-photos', (event, options) => {
            console.log('收到更新数据:', options);
            
            // 先设置数据
            if (options.photos) {
                currentPhotos = options.photos;
            }
            
            if (options.bounds) {
                mapBounds = options.bounds;
            }
            
            // 然后切换tab
            if (options.tab) {
                switchTab(options.tab);
            }
            
            // 渲染照片
            if (options.photos) {
                setTimeout(() => {
                    renderPhotos();
                    updateSelectedCount();
                }, 50);
            }
            
            // 处理Like状态变化
            if (options.likeChanged) {
                const { directory, filename, like } = options.likeChanged;
                // 更新当前数据中的like状态
                const photo = currentPhotos.find(p => p.directory === directory && p.filename === filename);
                if (photo) {
                    photo.like = like;
                }
                // 更新缩略图中的like图标
                const grid = document.getElementById('photosGrid');
                const thumbnails = grid.querySelectorAll('.photo-item');
                thumbnails.forEach(thumb => {
                    const dir = thumb.dataset.directory;
                    const file = thumb.dataset.filename;
                    if (dir === directory && file === filename) {
                        // 移除现有的like图标
                        const existingIcon = thumb.querySelector('.like-icon');
                        if (existingIcon) {
                            existingIcon.remove();
                        }
                        // 如果like为true，添加图标
                        if (like) {
                            const likeIcon = document.createElement('span');
                            likeIcon.className = 'like-icon';
                            likeIcon.textContent = '♥';
                            thumb.appendChild(likeIcon);
                        }
                    }
                });
            }
        });

        // 渲染照片网格（异步分批渲染）
        function renderPhotos() {
            console.log('renderPhotos被调用，当前照片数量:', currentPhotos?.length);
            const grid = document.getElementById('photosGrid');
            if (!grid) {
                console.error('找不到photosGrid元素！');
                return;
            }
            
            grid.innerHTML = '';

            if (!currentPhotos || currentPhotos.length === 0) {
                console.log('没有照片可显示');
                grid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #888;">${i18n.t('manage.noPhotos')}</div>`;
                return;
            }

            // 按时间排序，并保存到全局变量供翻页导航使用
            sortedCurrentPhotos = [...currentPhotos].sort((a, b) => {
                const timeA = a.time ? new Date(a.time).getTime() : 0;
                const timeB = b.time ? new Date(b.time).getTime() : 0;
                return timeA - timeB;
            });
            const sortedPhotos = sortedCurrentPhotos;

            console.log('开始渲染', sortedPhotos.length, '张照片');
            
            // 分批渲染，每批 20 张
            const batchSize = 20;
            let currentIndex = 0;

            function renderBatch() {
                const endIndex = Math.min(currentIndex + batchSize, sortedPhotos.length);
                
                for (let i = currentIndex; i < endIndex; i++) {
                    const photoItem = createPhotoItem(sortedPhotos[i]);
                    grid.appendChild(photoItem);
                }

                currentIndex = endIndex;

                if (currentIndex < sortedPhotos.length) {
                    // 使用 requestIdleCallback 或 setTimeout 继续渲染
                    if (window.requestIdleCallback) {
                        requestIdleCallback(renderBatch);
                    } else {
                        setTimeout(renderBatch, 0);
                    }
                } else {
                    // 渲染完成，初始化 Intersection Observer
                    initLazyLoading();
                    updateSelectedCount();
                }
            }

            renderBatch();
        }

        // 创建照片项（懒加载）
        function createPhotoItem(photo) {
            const div = document.createElement('div');
            div.className = 'photo-item loading';
            // 统一使用字符串格式的ID
            div.dataset.photoId = photo.id ? String(photo.id) : `${photo.directory}/${photo.filename}`;

            const filePath = photo.fullPath || `${photo.directory}/${photo.filename}`;
            const isVideo = photo.type === 'video';

            // 存储数据到 dataset 以便后续加载
            div.dataset.filePath = filePath; // 存储完整路径
            div.dataset.directory = photo.directory; // 存储相对目录
            div.dataset.filename = photo.filename; // 存储文件名
            div.dataset.isVideo = isVideo;
            div.dataset.loaded = 'false';

            // 存储photo对象用于事件处理
            div._photoData = photo;

            // 添加Like图标（如果已点赞）
            if (photo.like) {
                const likeIcon = document.createElement('span');
                likeIcon.className = 'like-icon';
                likeIcon.textContent = '♥';
                div.appendChild(likeIcon);
            }

            // 添加照片信息
            const info = document.createElement('div');
            info.className = 'photo-info';
            info.textContent = formatDateTime(photo.time);
            div.appendChild(info);

            // 点击事件 - 选中/取消选中（延迟执行以避免与双击冲突）
            div.addEventListener('click', (e) => {
                if (clickTimer) {
                    clearTimeout(clickTimer);
                    clickTimer = null;
                    return; // 这是双击的第二次点击，忽略它
                }
                
                clickTimer = setTimeout(() => {
                    clickTimer = null;
                    togglePhotoSelection(div, photo);
                }, 250); // 250ms 内如果有第二次点击，则视为双击
            });

            // 双击事件 - 先选中再打开照片窗口
            div.addEventListener('dblclick', async (e) => {
                // 清除单击定时器，防止执行单击操作
                if (clickTimer) {
                    clearTimeout(clickTimer);
                    clickTimer = null;
                }
                
                const photoId = div.dataset.photoId;
                
                // 如果未选中，先选中
                if (selectedPhotoId !== photoId) {
                    // 取消之前的选中
                    if (selectedPhotoId) {
                        const prevSelected = document.querySelector(`.photo-item[data-photo-id="${selectedPhotoId}"]`);
                        if (prevSelected) {
                            prevSelected.classList.remove('selected');
                        }
                    }
                    
                    // 选中当前照片
                    selectedPhotoId = photoId;
                    div.classList.add('selected');
                    updateSelectedCount();
                }
                
                // 打开照片窗口（传递导航上下文）
                const navIndex = sortedCurrentPhotos.indexOf(photo);
                const navPhotos = sortedCurrentPhotos.map(p => ({ directory: p.directory, filename: p.filename }));
                await ipcRenderer.invoke('open-photo-window', { photo, navPhotos, currentIndex: navIndex });
            });

            return div;
        }

        // 切换照片选中状态（单选）
        function togglePhotoSelection(element, photo) {
            const photoId = element.dataset.photoId;

            // 取消之前的选中
            if (selectedPhotoId) {
                const prevSelected = document.querySelector(`.photo-item[data-photo-id="${selectedPhotoId}"]`);
                if (prevSelected) {
                    prevSelected.classList.remove('selected');
                }
            }

            // 如果点击的不是已选中的照片，选中它
            if (selectedPhotoId !== photoId) {
                selectedPhotoId = photoId;
                element.classList.add('selected');
            } else {
                // 点击已选中的照片，取消选中
                selectedPhotoId = null;
            }

            updateSelectedCount();
        }

        // 更新选中数量显示（显示通过矩形选择的照片总数）
        function updateSelectedCount() {
            const countElement = document.getElementById('selected-count');
            if (countElement) {
                countElement.textContent = currentPhotos.length.toString();
            }
        }

        // 初始化懒加载
        function initLazyLoading() {
            // 清除旧的 observer
            if (intersectionObserver) {
                intersectionObserver.disconnect();
            }

            // 创建 Intersection Observer
            intersectionObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const photoItem = entry.target;
                        if (photoItem.dataset.loaded === 'false') {
                            loadPhotoContent(photoItem);
                            intersectionObserver.unobserve(photoItem);
                        }
                    }
                });
            }, {
                root: document.querySelector('.right-panel'),
                rootMargin: '100px', // 提前 100px 开始加载
                threshold: 0.01
            });

            // 监听所有照片项
            const photoItems = document.querySelectorAll('.photo-item');
            photoItems.forEach(item => {
                intersectionObserver.observe(item);
            });
        }

        // 处理缩略图生成队列（串行处理，一次只处理一张）
        async function processThumbnailQueue() {
            if (isProcessingThumbnail || thumbnailQueue.length === 0) {
                return;
            }
            
            isProcessingThumbnail = true;
            
            while (thumbnailQueue.length > 0) {
                const task = thumbnailQueue.shift();
                try {
                    await ThumbnailGenerator.generateAndSaveThumbnail(task.element, task.path);
                    console.log(`缩略图已生成: ${task.path}`);
                } catch (err) {
                    console.error('生成缩略图失败:', err);
                }
                
                // 稍微延迟一下，避免占用过多CPU
                await new Promise(resolve => setTimeout(resolve, 50));
            }
            
            isProcessingThumbnail = false;
        }

        // 添加缩略图生成任务到队列
        function enqueueThumbnailGeneration(element, path) {
            thumbnailQueue.push({ element, path });
            processThumbnailQueue();
        }

        // 加载照片内容
        function loadPhotoContent(photoItem) {
            const originalPath = photoItem.dataset.filePath;
            const isVideo = photoItem.dataset.isVideo === 'true';

            photoItem.dataset.loaded = 'true';

            // 获取缩略图路径
            const thumbnailInfo = ThumbnailGenerator.getThumbnailPath(originalPath);
            const displayPath = thumbnailInfo.path;
            const fileUrl = ThumbnailGenerator.toFileUrl(displayPath);

            const info = photoItem.querySelector('.photo-info');

            if (isVideo) {
                if (thumbnailInfo.isThumbnail) {
                    // 如果有缩略图，直接显示图片而不是视频
                    const img = document.createElement('img');
                    img.src = fileUrl;
                    img.onload = () => {
                        photoItem.classList.remove('loading');
                    };
                    img.onerror = () => {
                        photoItem.classList.remove('loading');
                        photoItem.style.backgroundColor = '#333';
                    };
                    photoItem.insertBefore(img, info);

                    const overlay = document.createElement('div');
                    overlay.className = 'video-overlay';
                    photoItem.insertBefore(overlay, info);
                } else {
                    // 没有缩略图，加载视频并加入缩略图生成队列
                    const video = document.createElement('video');
                    video.src = fileUrl;
                    video.preload = 'metadata';
                    video.muted = true;
                    video.addEventListener('loadedmetadata', () => {
                        video.currentTime = 0.1;
                        photoItem.classList.remove('loading');
                    });
                    video.addEventListener('seeked', () => {
                        // 将缩略图生成任务加入队列
                        enqueueThumbnailGeneration(video, originalPath);
                    }, { once: true });
                    video.onerror = () => {
                        photoItem.classList.remove('loading');
                        photoItem.style.backgroundColor = '#333';
                    };
                    photoItem.insertBefore(video, info);

                    const overlay = document.createElement('div');
                    overlay.className = 'video-overlay';
                    photoItem.insertBefore(overlay, info);
                }
            } else {
                const img = document.createElement('img');
                img.src = fileUrl;
                img.onload = () => {
                    photoItem.classList.remove('loading');
                    // 如果不是缩略图，将生成任务加入队列
                    if (!thumbnailInfo.isThumbnail) {
                        enqueueThumbnailGeneration(img, originalPath);
                    }
                };
                img.onerror = () => {
                    photoItem.classList.remove('loading');
                    photoItem.style.backgroundColor = '#333';
                    const errorDiv = document.createElement('div');
                    errorDiv.style.cssText = 'display:flex;align-items:center;justify-content:center;height:100%;color:#666;';
                    errorDiv.textContent = 'Failed to load';
                    photoItem.insertBefore(errorDiv, photoItem.firstChild);
                };
                photoItem.insertBefore(img, info);
            }
        }

        // 绘制地图缩略图
        function drawMapThumbnail() {
            console.log('drawMapThumbnail被调用');
            if (!mapBounds || !currentPhotos || currentPhotos.length === 0) {
                console.log('drawMapThumbnail跳过: mapBounds=', mapBounds, 'currentPhotos.length=', currentPhotos?.length);
                return;
            }

            const mapContainer = document.getElementById('selectedMapContainer');
            if (!mapContainer) {
                console.error('找不到selectedMapContainer元素！');
                return;
            }

            // 如果地图已存在，先清除
            if (miniMap) {
                console.log('清除现有地图');
                miniMap.remove();
                miniMap = null;
                miniMapMarkers = [];
            }

            // 计算地图中心和缩放级别
            const { north, south, east, west } = mapBounds;
            const centerLat = (north + south) / 2;
            const centerLng = (east + west) / 2;
            
            console.log('创建小地图，中心:', [centerLat, centerLng]);
            // 创建小地图
            miniMap = L.map('selectedMapContainer', {
                center: [centerLat, centerLng],
                zoom: 12,
                zoomControl: false,
                dragging: false,
                scrollWheelZoom: false,
                doubleClickZoom: false,
                boxZoom: false,
                keyboard: false,
                attributionControl: false
            });

            // 添加卫星底图
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: ''
            }).addTo(miniMap);

            // 添加标签图层
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
                attribution: '',
                subdomains: 'abcd',
                pane: 'overlayPane'
            }).addTo(miniMap);

            // 绘制矩形选框
            L.rectangle([[south, west], [north, east]], {
                color: '#ff7800',
                weight: 2,
                fill: false
            }).addTo(miniMap);

            // 禁用地图容器的键盘事件（已经获取了mapContainer，不需要重复获取）
            mapContainer.addEventListener('keydown', (e) => {
                if (['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(e.key)) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            });
            // 确保地图容器不能获得焦点
            mapContainer.setAttribute('tabindex', '-1');

            // 添加照片标记
            console.log('添加', currentPhotos.length, '个照片标记');
            currentPhotos.forEach(photo => {
                if (photo.lat && photo.lng) {
                    const marker = L.circleMarker([photo.lat, photo.lng], {
                        radius: 5,
                        fillColor: '#4a9eff',
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                    marker.addTo(miniMap);
                    miniMapMarkers.push(marker);
                }
            });

            // 自动调整视图以适应矩形范围
            miniMap.fitBounds([[south, west], [north, east]], { padding: [10, 10] });

            // 强制刷新地图尺寸
            setTimeout(() => {
                if (miniMap) {
                    console.log('刷新地图尺寸');
                    miniMap.invalidateSize();
                }
            }, 100);

            // 更新照片数量徽章
            const badge = document.getElementById('photo-count-badge');
            if (badge) {
                badge.textContent = i18n.t('manage.photoCount', { count: currentPhotos.length });
                console.log('更新徽章:', badge.textContent);
            } else {
                console.error('找不到photo-count-badge元素！');
            }
        }

        // 格式化日期时间
        function formatDateTime(timeStr) {
            if (!timeStr) return 'Unknown Date';
            const d = new Date(timeStr);
            if (isNaN(d.getTime())) return 'Unknown Date';
            
            return `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
        }

        // 窗口 resize 时重新调整地图大小
        window.addEventListener('resize', () => {
            if (miniMap) {
                setTimeout(() => {
                    miniMap.invalidateSize();
                }, 100);
            }
        });

        // 监听窗口焦点，当从照片窗口返回时重新聚焦到照片网格
        window.addEventListener('focus', () => {
            console.log('窗口获得焦点');
            // 立即聚焦到右侧面板，确保键盘事件能正确处理
            const rightPanel = document.querySelector('.right-panel');
            if (rightPanel) {
                // 使用更短的延迟确保焦点快速返回
                setTimeout(() => {
                    rightPanel.focus();
                    console.log('右侧面板已聚焦');
                }, 50);
            }
        });

        // 键盘导航功能
        document.addEventListener('keydown', async (e) => {
            // 只处理方向键和回车键
            if (!['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Enter'].includes(e.key)) {
                return;
            }

            console.log('键盘事件:', e.key);
            
            // 如果当前没有选中的照片，不处理
            if (!selectedPhotoId) {
                console.log('没有选中的照片，忽略键盘事件');
                return;
            }

            const currentSelected = document.querySelector(`.photo-item[data-photo-id="${selectedPhotoId}"]`);
            if (!currentSelected) {
                return;
            }

            // 获取所有照片元素
            const allPhotos = Array.from(document.querySelectorAll('.photo-item'));
            const currentIndex = allPhotos.indexOf(currentSelected);
            
            if (currentIndex === -1) {
                return;
            }

            // 获取网格的列数
            const grid = document.getElementById('photosGrid');
            const gridStyle = window.getComputedStyle(grid);
            const gridTemplateColumns = gridStyle.gridTemplateColumns.split(' ').length;
            
            let nextIndex = -1;
            
            switch(e.key) {
                case 'ArrowLeft':
                    // 向左切换
                    e.preventDefault();
                    e.stopPropagation();
                    nextIndex = currentIndex - 1;
                    if (nextIndex >= 0) {
                        selectPhotoByIndex(allPhotos, nextIndex);
                    }
                    break;
                    
                case 'ArrowRight':
                    // 向右切换
                    e.preventDefault();
                    e.stopPropagation();
                    nextIndex = currentIndex + 1;
                    if (nextIndex < allPhotos.length) {
                        selectPhotoByIndex(allPhotos, nextIndex);
                    }
                    break;
                    
                case 'ArrowUp':
                    // 向上切换（上一行）
                    e.preventDefault();
                    e.stopPropagation();
                    nextIndex = currentIndex - gridTemplateColumns;
                    if (nextIndex >= 0) {
                        selectPhotoByIndex(allPhotos, nextIndex);
                    }
                    break;
                    
                case 'ArrowDown':
                    // 向下切换（下一行）
                    e.preventDefault();
                    e.stopPropagation();
                    nextIndex = currentIndex + gridTemplateColumns;
                    if (nextIndex < allPhotos.length) {
                        selectPhotoByIndex(allPhotos, nextIndex);
                    }
                    break;
                    
                case 'Enter':
                    // 回车键打开照片
                    e.preventDefault();
                    e.stopPropagation();
                    const photoData = currentSelected._photoData;
                    if (photoData) {
                        console.log('打开照片窗口:', photoData.filename);
                        const navIndex = sortedCurrentPhotos.indexOf(photoData);
                        const navPhotos = sortedCurrentPhotos.map(p => ({ directory: p.directory, filename: p.filename }));
                        await ipcRenderer.invoke('open-photo-window', { photo: photoData, navPhotos, currentIndex: navIndex });
                        // 焦点会在照片窗口关闭时通过 window focus 事件自动恢复
                    }
                    break;
            }
        });

        // 根据索引选中照片并滚动到可见区域
        function selectPhotoByIndex(allPhotos, index) {
            const nextPhoto = allPhotos[index];
            if (!nextPhoto) {
                return;
            }
            
            // 取消之前的选中
            if (selectedPhotoId) {
                const prevSelected = document.querySelector(`.photo-item[data-photo-id="${selectedPhotoId}"]`);
                if (prevSelected) {
                    prevSelected.classList.remove('selected');
                }
            }
            
            // 选中新照片
            selectedPhotoId = nextPhoto.dataset.photoId;
            nextPhoto.classList.add('selected');
            
            // 滚动到可见区域
            const rightPanel = document.querySelector('.right-panel');
            const photoRect = nextPhoto.getBoundingClientRect();
            const panelRect = rightPanel.getBoundingClientRect();
            
            // 检查照片是否在可视区域内
            if (photoRect.top < panelRect.top || photoRect.bottom > panelRect.bottom) {
                nextPhoto.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center',
                    inline: 'center'
                });
            }
            
            updateSelectedCount();
        }
    </script>
</body>
</html>
